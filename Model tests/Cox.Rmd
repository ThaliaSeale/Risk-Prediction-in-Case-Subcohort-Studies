---
title: "Cox simulations"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r, setup}
library(tidyverse)
library(magrittr)
library(purrr)
# library(coxphw)
library(survival)
library(intsurv)
```


# Weibull simple linear

Function to generate simulated data for Weibull with simple linear predictors. Randomly sets some to be categorical and some to be normal.

$\beta \sim \mathcal{N}_{n_\beta}(0,\sigma)$, $x_i \sim \mathcal{N}_{n_\beta}(0,1)$, $y_i \sim \text{Weib}(c,\exp(x_i ^T \beta/c))$, $c \sim \Gamma(1)$.

```{r}
rweibull_v <- Vectorize(rweibull, vectorize.args = "scale")

weibull_simple_linear_sim <- function(n_beta, prop_cat, obs, censor_prop, sigma = 1){
  betas <- rnorm(n_beta, sd = sigma)
  print(betas)
  X_norm <- rnorm(obs*floor(n_beta*prop_cat))
  X_norm <- matrix(X_norm, nrow = obs, ncol = floor(n_beta*prop_cat))
  X_cat <- as.numeric(rbernoulli(obs*ceiling(n_beta*(1-prop_cat))))
  X_cat <- matrix(X_cat, nrow = obs, ncol = ceiling(n_beta*(1-prop_cat)))
  X <- cbind(X_norm,X_cat)
  
  c = runif(1,0.5,5)
  
  lin_pred <- X %*% betas
  
  sim_data <- as.data.frame(X)
  sim_data[["lin_pred"]] <- lin_pred
  sim_data %<>%
    mutate(y = rweibull_v(1,c, scale = exp(-lin_pred/c)))
  
  dropout_prop <- runif(1,max = 0.5)*censor_prop
  sim_data[["dropout"]] <- rbernoulli(obs,dropout_prop)
  sim_data %<>%
    mutate(y_dropout = ifelse(dropout,runif(1,max = y),y))
  max_time <- quantile(sim_data[["y_dropout"]], probs = 1 - censor_prop)
  sim_data %<>%
    mutate(censor = y_dropout > max_time,
           y_censor = pmin(y_dropout, max_time),
           event = !(dropout | censor))
  sim_data[["id"]] <- 1:nrow(sim_data)
  
  return(sim_data)
}
```

Demonstration of function:

```{r}
weibull_simple_linear_sim(3,0.5,10,0.7)
```

# Single sample test

Now let us draw a single sample to test out Cox regression:

```{r}
sample <- weibull_simple_linear_sim(10,0.5,1500,0.9)
# Use first 1000 samples as the cohort set
cohort <- head(sample,1000)
head(cohort)
```
Extracting cases:

```{r}
cases <- cohort %>%
  filter(event)
head(cases)
```
Selecting subcohort:

```{r}
subcohort <- cohort %>%
  slice_sample(n = nrow(cases))
head(subcohort)
```
The case-subcohort dataset:

```{r}
case_subcohort <- rbind(cases,subcohort)
case_subcohort <- case_subcohort[,c(1:10,16:17)]
head(case_subcohort)
```

Now to fit the model:

```{r}
subcoh_ind <- c(rep(0,nrow(cases)),rep(1,nrow(subcohort)))
coxph_fit <- cch(Surv(y_censor,event) ~ ., case_subcohort, subcoh = subcoh_ind, 
                 id = 1:nrow(case_subcohort), cohort.size = 1000, 
                 method = "LinYing", robust = TRUE)
coxph_fit
```

We can see that the coefficients can be estimated, but how is the prediction accuracy?

```{r}
test <- sample[1001:1500,]
test_X <- test %>% select(1:10)
test_y <- unlist(test %>% select(y_censor))
test_event <- unlist(test %>% select(event))

coeffs <- coxph_fit$coefficients
coeffs
lin_preds <- unlist(as.matrix(test_X) %*% (coeffs))

cIndex(test_y,test_event,lin_preds)
```
So pretty good concordance here.

Try fitting with Christiana's method:

First writing a function that prepares the data frame.

```{r}
cch_prep <- function(cases, subcohort){
  cases %<>%
    mutate(start_time = y_censor - 0.0001,
           subcohort = FALSE)
  subcohort %<>%
    mutate(y_censor = ifelse(event,y_censor - 0.0001,y_censor),
           start_time = 0,
           subcohort = TRUE)
  return(rbind(cases,subcohort))
}

case_subcohort <- cch_prep(cases,subcohort)
case_subcohort %>% filter(event,subcohort)
```

Now we fit the Cox proportional hazards model.

```{r}
case_subcohort %<>%
  select(1:10,y_censor,event,start_time,subcohort)
samp_frac <- nrow(subcohort)/nrow(cohort)
samp_frac
case_subcohort %<>%
  mutate(subcohort = ifelse(subcohort,1/samp_frac,1))

case_subcohort %<>%
  select(1:10,y_censor,event,start_time,subcohort)
samp_frac <- nrow(subcohort)/nrow(cohort)
samp_frac
case_subcohort %<>%
  mutate(subcohort = ifelse(subcohort,1/samp_frac,1))

coxph(Surv(start_time, y_censor, event) ~ . - subcohort, data = case_subcohort, weights = subcohort)

```

```{r}
case_subcohort %<>%
  select(1:10,y_censor,event,start_time,subcohort)
samp_frac <- nrow(subcohort)/nrow(cohort)
samp_frac
case_subcohort %<>%
  mutate(subcohort = ifelse(subcohort,1/samp_frac,1))

coxph(Surv(start_time, y_censor, event) ~ . - subcohort, data = case_subcohort, weights = subcohort)
```

